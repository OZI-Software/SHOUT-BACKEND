generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enum for user roles, based on the 'users' table design
enum UserRole {
  SUPER_ADMIN
  ADMIN
  STAFF
  CUSTOMER
}

// Enum for offer status, based on the 'offers' table design
enum OfferStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  EXPIRED
}

// Enum for business approval workflow
enum BusinessStatus {
  PENDING
  APPROVED
  REJECTED
}

model User {
  // Corresponds to PK id (uuid)
  userId String @id @default(uuid())

  // Corresponds to email (string)
  email String? @unique
  
  // Mobile number for login
  mobileNumber String? @unique

  // User's full name
  name String?

  // Securely stored bcrypt password hash
  // Optional because businesses might register without a password initially (waiting for approval)
  passwordHash String?

  // Corresponds to role (enum)
  role UserRole @default(STAFF)

  // Corresponds to created_at
  createdAt DateTime @default(now())

  // --- Relations ---

  // 1-to-1 relation to a Business profile
  business Business?

  // 1-to-many relation for an Admin creating offers
  // 1-to-many relation for an Admin creating offers
  createdOffers Offer[] @relation("AdminOffers")

  // Customer relations
  favorites FavoriteOffer[]
  reviews   Review[]

  @@map("users")
}

model Business {
  // Corresponds to PK id (uuid)
  businessId String @id @default(uuid())

  // This is a 1-to-1 relation
  userId String @unique
  user   User   @relation(fields: [userId], references: [userId])

  // Corresponds to business_name (string)
  businessName String

  // Corresponds to description (text)
  description String

  // Corresponds to address (text)
  address String

  pinCode Int

  googleMapsLink String
  latitude       Float
  longitude      Float

  // Business hours
  openingTime   String?  // e.g., "09:00"
  closingTime   String?  // e.g., "22:00"
  workingDays   String?  // e.g., "Mon,Tue,Wed,Thu,Fri,Sat,Sun"
  isOpen24Hours Boolean  @default(false)

  // Corresponds to created_at
  createdAt DateTime @default(now())

  // Approval workflow fields
  status     BusinessStatus @default(PENDING)
  approvedAt DateTime?
  approvedBy String?
  reviewNote String?

  // add a GIST index manually in SQL for PostGIS:
  // CREATE INDEX "business_location_idx" ON "Business" USING GIST (
  //   ST_MakePoint(longitude, latitude)::geography
  // );

  // ABC Code for business registration
  abcCode String?

  // Reviews
  reviews Review[]

  @@index([latitude, longitude, businessId])
  @@index([status])
  @@map("businesses")
}

model Offer {
  // Corresponds to PK id (uuid)
  id String @id @default(uuid())

  // Corresponds to FK creator_id(uuid)
  creatorId String
  creator   User   @relation("AdminOffers", fields: [creatorId], references: [userId])

  // Corresponds to title (string)
  title String

  // Corresponds to description (text)
  description String

  // Corresponds to image_url (string)
  imageUrl String

  // Corresponds to status (enum)
  status OfferStatus @default(DRAFT)

  // Corresponds to start_datetime
  startDateTime DateTime

  // Corresponds to end_datetime
  endDateTime DateTime

  // Corresponds to reposted_from (uuid)
  // This is a self-referencing relation to track reposts
  repostedFromOfferId String?
  repostedFrom        Offer?  @relation("Repost", fields: [repostedFromOfferId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Relation to track offers that were reposted from this one
  repostedOffers Offer[] @relation("Repost")

  // Corresponds to created_at
  createdAt DateTime @default(now())

  @@index([creatorId])
  @@index([repostedFromOfferId])
  @@index([status, startDateTime, endDateTime])
  @@map("offers")
  
  // Relations
  favoritedBy FavoriteOffer[]
}

model FavoriteOffer {
  userId  String
  offerId String
  user    User   @relation(fields: [userId], references: [userId], onDelete: Cascade)
  offer   Offer  @relation(fields: [offerId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@id([userId, offerId])
  @@map("favorite_offers")
}

model Review {
  id String @id @default(uuid())
  
  userId String
  user   User   @relation(fields: [userId], references: [userId])
  
  businessId String
  business   Business @relation(fields: [businessId], references: [businessId], onDelete: Cascade)
  
  rating Int // 1-5
  comment String?
  
  createdAt DateTime @default(now())
  
  @@index([businessId])
  @@map("reviews")
}

model OtpVerification {
  id        String   @id @default(uuid())
  email     String
  otp       String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@map("otp_verifications")
}
